version: "3.7"
services:
  db:
    image: postgres:15.4
    restart: unless-stopped
    networks:
      - spejstore
    volumes:
      - spejstore-db:/var/lib/postgresql/data
    environment:
      POSTGRES_USER: ${POSTGRES_USER}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: ${POSTGRES_DB} #TODO CHANGE
    healthcheck:
      #CHANGE 1: this command checks if the database is ready, right on the source db server
      test: ["CMD-SHELL", "pg_isready -d postgres -U postgres"]
      interval: 1s
      timeout: 1s
      retries: 5
  web:
    restart: unless-stopped
    command: bash -c "python manage.py collectstatic --no-input --clear && python manage.py migrate && gunicorn --workers 1 --threads 4 -b 0.0.0.0:8000 --capture-output --error-logfile - --access-logfile - spejstore.wsgi:application"
    image: ghcr.io/hackerspacekrk/spejstore:master
    networks:
      - system_default
      - spejstore
    secrets:
      - spejstore_clientid
      - spejstore_secret
    environment:
      SPEJSTORE_CLIENT_ID: ${SPEJSTORE_CLIENTID}
      SPEJSTORE_SECRET: ${SPEJSTORE_SECRET}
      SPEJSTORE_DB_NAME: ${POSTGRES_DB}
      SPEJSTORE_DB_PASSWORD: ${POSTGRES_PASSWORD}
      SPEJSTORE_DB_USER: ${POSTGRES_USER}
      SPEJSTORE_DB_HOST: ${POSTGRES_HOST}
      SPEJSTORE_ALLOWED_HOSTS: ${SPEJSTORE_ALLOWED_HOSTS}
      SPEJSTORE_ENV: ${SPEJSTORE_ENV}
    depends_on:
      - db
    deploy:
      labels:
        - "traefik.enable=true"
        - "traefik.docker.network=system_default"
        - "traefik.http.services.spejstore.loadbalancer.server.port=8000"
        - "traefik.http.routers.spejstore.rule=Host(`spejstore.apps.hskrk.pl`)"
        - "traefik.http.routers.spejstore.tls=true"
        - "traefik.http.routers.spejstore.tls.certresolver=myresolver"

volumes:
  spejstore-db:

secrets:
  spejstore_secret:
    external: true
  spejstore_clientid:
    external: true

networks:
  system_default:
    external: true
  spejstore:
    internal: true
    external: false
